<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/logged_in.css">
    <script src="https://kit.fontawesome.com/f85aa908bc.js" crossorigin="anonymous"></script>
    <title>DashBoard</title>

</head>

<body>
    <h1>Welcome to your dashboard!</h1>
    <div class="media-body">
        <div class="pull-left">
            <img class="media-object" width="150" src="<%=images[0].url%>" />
        </div>
        <div class="media-body">
            <dl class="dl-horizontal">
                <dt>Name:</dt>
                <dd class="clearfix"><%=display_name%></dd>
                <dt>Id:</dt>
                <dd><%=id%></dd>
                <dt>Email:</dt>
                <dd><%=email%></dd>
                <dt>Spotify URI:</dt>
                <dd><a href="<%=external_urls.spotify%>"><%=external_urls.spotify%></a></dd>
                <dt>Link:</dt>
                <dd><a href="<%=href%>"><%=href%></a></dd>
                <dt>Profile Image:</dt>
                <dd class="clearfix"><a href="<%=images[0].url%>"><%=images[0].url%></a></dd>
                <dt>Country:</dt>
                <dd><%=country%></dd>
                <dt>Access Token:</dt>
                <dd id="access_token"><%=access_token%></dd>
                <dt id="refresh_token">Refresh Token:</dt>
                <dd><%=refresh_token%></dd>
            </dl>
        </div>
    </div>

    <div style="display: flex; flex-direction: row; justify-content: space-evenly; width: 100%;">
        <div>
            <!-- <a style="align-items: center;" href="/refresh_token" class="btn btn-primary"> grab a new access token! </a> -->
            <span>Your Top Artists: </span>
            <ul>
                <li>Artist1: <%=artist_1%></li>
                <li>Artist2: <%=artist_2%></li>
                <li>Artist3: <%=artist_3%></li>
                <li>Artist4: <%=artist_4%></li>
                <li>Artist5: <%=artist_5%></li>
                <li>Artist6: <%=artist_6%></li>
                <li>Artist7: <%=artist_7%></li>
                <li>Artist8: <%=artist_8%></li>
                <li>Artist9: <%=artist_9%></li>
                <li>Artist10: <%=artist_10%></li>
            </ul>

        </div>
        <div>
            <!-- <a style="align-items: center;" href="/refresh_token" class="btn btn-primary"> grab a new access token! </a> -->

            <span>Your Top Tracks: </span>
            <ul>
                <li>Track1: <%=track_1%></li>
                <li>Track2: <%=track_2%></li>
                <li>Track3: <%=track_3%></li>
                <li>Track4: <%=track_4%></li>
                <li>Track5: <%=track_5%></li>
                <li>Track6: <%=track_6%></li>
                <li>Track7: <%=track_7%></li>
                <li>Track8: <%=track_8%></li>
                <li>Track9: <%=track_9%></li>
                <li>Track10: <%=track_10%></li>
            </ul>

        </div>
        <div>
            <a style="align-items: center;" href="/getRecommendations" class="btn btn-primary"> Suggest me songs! </a>
            <% if (recommendationInfo) { %>
            <button id="pause"> Pause </button> <button id="resume"> Resume </button>
            <ul>
                <li>Recommendation1: <%=rec_1%> <i id="play1" class="fas fa-play"></i> </li>
                </br>
                <span class="hidden" id="val1"> <%=uri_1%> </span>

                <li>Recommendation2: <%=rec_2%> <i id="play2" class="fas fa-play"></i> </li>
                <span class="hidden" id="val2"> <%=uri_2%> </span>
                </br>
                <li>Recommendation3: <%=rec_3%> <i id="play3" class="fas fa-play"></i> </li>
                <span class="hidden" id="val3"> <%=uri_3%> </span>
                </br>
                <li>Recommendation4: <%=rec_4%> <i id="play4" class="fas fa-play"></i> </li>
                <span class="hidden" id="val4"> <%=uri_4%> </span>
                </br>
                <li>Recommendation5: <%=rec_5%> <i id="play5" class="fas fa-play"></i> </li>
                <span class="hidden" id="val5"> <%=uri_5%> </span>
                </br>
                <li>Recommendation6: <%=rec_6%> <i id="play6" class="fas fa-play"></i> </li>
                <span class="hidden" id="val6"> <%=uri_6%> </span>
                </br>
                <li>Recommendation7: <%=rec_7%> <i id="play7" class="fas fa-play"></i> </li>
                <span class="hidden" id="val7"> <%=uri_7%> </span>
                </br>
                <li>Recommendation8: <%=rec_8%> <i id="play8" class="fas fa-play"></i> </li>
                <span class="hidden" id="val8"> <%=uri_8%> </span>
                </br>
                <li>Recommendation9: <%=rec_9%> <i id="play9" class="fas fa-play"></i> </li>
                <span class="hidden" id="val9"> <%=uri_9%> </span>
                </br>
                <li>Recommendation10: <%=rec_10%> <i id="play10" class="fas fa-play"></i> </li>
                <span class="hidden" id="val10"> <%=uri_10%> </span>
                </br>
            </ul>
            <% } %>
        </div>
    </div>
    <script type="module" src="/js/logged_in.js"></script>
    <script src="https://sdk.scdn.co/spotify-player.js"></script>
    <script>
        window.onSpotifyWebPlaybackSDKReady = () => {
            const token = document.getElementById('access_token').innerText;
            // console.log(token);
            // const uri = document.getElementById('val1').innerText;
            let deviceId = null;
            const player = new Spotify.Player({
                name: 'Web Playback SDK Quick Start Player',
                getOAuthToken: cb => {
                    cb(token);
                }
            });

            // Error handling
            player.addListener('initialization_error', ({
                message
            }) => {
                console.error(message);
            });
            player.addListener('authentication_error', ({
                message
            }) => {
                console.error(message);
            });
            player.addListener('account_error', ({
                message
            }) => {
                console.error(message);
            });
            player.addListener('playback_error', ({
                message
            }) => {
                console.error(message);
            });

            // Playback status updates
            player.addListener('player_state_changed', state => {
                console.log(state);
            });

            // Ready
            player.addListener('ready', ({
                device_id
            }) => {
                deviceId = device_id;
                console.log('Ready with Device ID', device_id);
            });

            // Not Ready
            player.addListener('not_ready', ({
                device_id
            }) => {
                console.log('Device ID has gone offline', device_id);
            });

            player.connect().then(() => {
                console.log('connected....');
            });
            const play = ({
                spotify_uri,
                playerInstance: {
                    _options: {
                        getOAuthToken,
                        id
                    }
                }
            }) => {
                getOAuthToken(access_token => {
                    fetch(`https://api.spotify.com/v1/me/player/play?device_id=${id}`, {
                        method: 'PUT',
                        body: JSON.stringify({
                            uris: [spotify_uri.trim()]
                        }),
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${access_token}`
                        },
                    }).then(response => {
                        console.log(response)
                    }).then(result => console.log(
                        result)).catch(
                        err => console.log('errror:', err));
                });
            };
            for (let i = 1; i <= 10; i++) {
                document.getElementById(`play${i}`).addEventListener('click', () => {
                    const uri = document.getElementById(`val${i}`).innerText;
                    console.log('uriiii: ', uri);
                    play({
                        playerInstance: player,
                        spotify_uri: uri
                    })
                })
            }
            document.getElementById('pause').addEventListener('click', () => {
                player.pause().then(() => {
                    console.log('Paused!');
                });
            })
            document.getElementById('resume').addEventListener('click', () => {
                player.resume().then(() => {
                    console.log('Resumed!');
                });
            })
        };
    </script>
</body>

</html>